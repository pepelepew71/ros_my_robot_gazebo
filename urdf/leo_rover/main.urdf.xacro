<?xml version="1.0" encoding="utf-8"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro"
       name="leo_rover">

  <xacro:arg name="tf_odom_enabled" default="true" />
  <xacro:arg name="ns" default="" />

  <!-- include -->
  <xacro:include filename="$(find ros_my_robot_gazebo)/urdf/leo_rover/wheel.xacro" />
  <xacro:include filename="$(find ros_my_robot_gazebo)/urdf/leo_rover/imu.xacro" />
  <xacro:include filename="$(find ros_my_robot_gazebo)/urdf/leo_rover/rplidar.xacro" />

  <!-- global vars -->
  <xacro:property name="M_PI" value="3.1415926535897931" />

  <!-- base link -->
  <link name="$(arg ns)/base_link">
    <inertial>
      <mass value="5.0"/>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <inertia ixx="1" ixy="0" ixz="0" iyy="1" iyz="0" izz="1"/>
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="package://ros_my_robot_gazebo/mesh/leo_rover/base.dae"/>
      </geometry>
    </visual>
  </link>

  <gazebo reference="$(arg ns)/base_link">
      <material>Gazebo/Gray</material>
  </gazebo>

  <!-- wheel -->
  <xacro:wheel ns="(arg ns)" name="FL" model="left" mu1="5.0" mu2="2.0" />
  <xacro:wheel ns="(arg ns)" name="FR" model="right" mu1="5.0" mu2="2.0" />
  <xacro:wheel ns="(arg ns)" name="RL" model="left" mu1="0.0" mu2="0.0" />
  <xacro:wheel ns="(arg ns)" name="RR" model="right" mu1="0.0" mu2="0.0" />

  <joint name="$(arg ns)/wheel_FL_joint" type="continuous">
    <origin xyz="0.1472 0.1114 -0.1353" rpy="0 0 ${pi}"/>
    <parent link="$(arg ns)/base_link"/>
    <child link="$(arg ns)/wheel_FL_link"/>
    <axis xyz="0 -1 0"/>
  </joint>

  <joint name="$(arg ns)/wheel_FR_joint" type="continuous">
    <origin xyz="0.1472 -0.1114 -0.1353" rpy="0 0 0"/>
    <parent link="$(arg ns)/base_link"/>
    <child link="$(arg ns)/wheel_FR_link"/>
    <axis xyz="0 1 0"/>
  </joint>

  <joint name="$(arg ns)/wheel_RL_joint" type="continuous">
    <origin xyz="-0.1419 0.1114 -0.1353" rpy="0 0 ${pi}"/>
    <parent link="$(arg ns)/base_link"/>
    <child link="$(arg ns)/wheel_RL_link"/>
    <axis xyz="0 -1 0"/>
  </joint>

  <joint name="$(arg ns)/wheel_RR_joint" type="continuous">
    <origin xyz="-0.1419 -0.1114 -0.1353" rpy="0 0 0"/>
    <parent link="$(arg ns)/base_link"/>
    <child link="$(arg ns)/wheel_RR_link"/>
    <axis xyz="0 1 0"/>
  </joint>

  <!-- camera -->
  <link name="$(arg ns)/camera_frame"/>

  <joint name="$(arg ns)/camera_joint" type="fixed">
    <origin xyz="0.0971 0 -0.0427" rpy="0 0 0"/>
    <parent link="$(arg ns)/base_link"/>
    <child link="$(arg ns)/camera_frame"/>
  </joint>

  <!-- rplidar -->
  <joint name="$(arg ns)/rplidar_joint" type="fixed">
    <origin xyz="0.08 0 0.02" rpy="0 0 0" />
    <parent link="$(arg ns)/base_link"/>
    <child link="$(arg ns)/rplidar_link"/>
  </joint>

  <xacro:rplidar ns="$(arg ns)" />

  <!-- imu -->
  <joint name="$(arg ns)/imu_joint" type="fixed">
    <parent link="$(arg ns)/base_link"/>
    <child link="$(arg ns)/imu_link"/>
    <origin xyz="0.027 0 -0.07" rpy="0 0 0"/>
  </joint>

  <xacro:imu ns="$(arg ns)" />

  <!-- camera -->
  <gazebo reference="camera_frame">
    <sensor type="camera" name="camera_node">
      <update_rate>30.0</update_rate>
      <camera name="head">
        <horizontal_fov>1.3962634</horizontal_fov>
        <image>
          <width>800</width>
          <height>600</height>
          <format>R8G8B8</format>
        </image>
        <clip>
          <near>0.02</near>
          <far>300</far>
        </clip>
        <noise>
          <type>gaussian</type>
          <mean>0.0</mean>
          <stddev>0.007</stddev>
        </noise>
      </camera>
      <plugin name="gazebo_camera" filename="libgazebo_ros_camera.so">
        <alwaysOn>true</alwaysOn>
        <updateRate>0.0</updateRate>
        <imageTopicName>image_raw</imageTopicName>
        <cameraInfoTopicName>camera_info</cameraInfoTopicName>
        <cameraName>camera</cameraName>
        <frameName>camera_frame</frameName>
        <hackBaseline>0.07</hackBaseline>
        <distortionK1>0.0</distortionK1>
        <distortionK2>0.0</distortionK2>
        <distortionK3>0.0</distortionK3>
        <distortionT1>0.0</distortionT1>
        <distortionT2>0.0</distortionT2>
      </plugin>
    </sensor>
  </gazebo>

  <!-- skid steering drive -->
  <gazebo>
    <plugin name="wheel_controller" filename="libgazebo_ros_skid_steer_drive.so">
      <updateRate>100.0</updateRate>
      <robotNamespace>$(arg ns)</robotNamespace>

      <leftFrontJoint>$(arg ns)/wheel_FL_joint</leftFrontJoint>
      <rightFrontJoint>$(arg ns)/wheel_FR_joint</rightFrontJoint>
      <leftRearJoint>$(arg ns)/wheel_RL_joint</leftRearJoint>
      <rightRearJoint>$(arg ns)/wheel_RR_joint</rightRearJoint>
      <wheelSeparation>0.32</wheelSeparation>
      <wheelDiameter>0.13</wheelDiameter>

      <robotBaseFrame>$(arg ns)/base_link</robotBaseFrame>
      <odometryFrame>$(arg ns)/odom</odometryFrame>

      <commandTopic>cmd_vel</commandTopic>
      <odometryTopic>odom</odometryTopic>

      <topicName>$(arg ns)/cmd_vel</topicName>
      <broadcastTF>$(arg tf_odom_enabled)</broadcastTF>

      <torque>30</torque>
      <covariance_x>0.001</covariance_x>
      <covariance_y>0.001</covariance_y>
      <covariance_yaw>0.01</covariance_yaw>

    </plugin>
  </gazebo>

</robot>